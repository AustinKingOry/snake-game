<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>
    <link rel="stylesheet" href="./App.css">
    <script src="../plugins/tailwind.js"></script>
    <script src="../plugins/jquery-3.7.0.min.js"></script>
</head>
<body class="fixed h-screen w-screen overflow-hidden bg-gray-700">
    <div class="container max-w-7xl h-full w-full mx-auto flex items-center justify-center">
        <div id="game-frame" class="cursor-pointer relative min-w-96 w-[480px] max-w-xl h-[540px] border rounded-0 shadow-md bg-gray-50 mx-auto">
            <div class="h-full w-full overflow-hidden" id="snake-grid">
            </div>
        </div>
    </div>
    <!-- <script src="./App.js"></script> -->
    <script>
        $(document).ready(function (){
            const gameFrame = $("#game-frame");
            let snakeGrid = $("#snake-grid");
            const tileWidth = 12;
            const tileHeight = 12;
            let columns = Math.floor(snakeGrid.width()/tileWidth),
            rows = Math.floor(snakeGrid.height()/tileHeight);
            let snakeHeadPosition = 0;
            let targetIndex = 0;
            let snakeSize = 2;
            let allDirections = ["top","right","bottom","left"]
            let snakeDirection = allDirections[1];
            let playerDirections = {x:"right",y:"bottom"};
            let changeDirection = false;
            let snakeRow = 0;
            let snakeColumn = 0;

            const createTile = index =>{
                const tile = `<div class="tile w-3 h-3 bg-gray-50 text-[6px]" data-index="${index}"></div>`;
                return tile;
            }
            const createTarget = index =>{
                const tile = $(".tile")[index];
                $(tile).addClass("bg-blue-600 flex-shrink-0 rounded");
            }
            const setSnakePosition = (index) =>{
                snakeDirection = allDirections[rand(0,allDirections.length-1)]; // random initial direction
                const tile = $(".tile")[index];
                $(tile).addClass("bg-gray-600 rounded head");
                if(snakeDirection == "left"){
                    const maxTiles = parseInt($(tile).data("index"))+snakeSize;
                    for(let i=index+1;i<maxTiles;i++){
                        let nextTile = $(".tile")[i];
                        $(nextTile).addClass("bg-gray-500 snake-piece rounded border border-gray-50");
                    }
                }
                if(snakeDirection == "right"){
                    const maxTiles = parseInt($(tile).data("index"))-snakeSize;
                    for(let i=index-1;i>maxTiles;i--){
                        let nextTile = $(".tile")[i];
                        $(nextTile).addClass("bg-gray-500 snake-piece rounded border border-gray-50");
                    }
                }
                if(snakeDirection == "top"){
                    const headIndex = parseInt($(tile).data("index"));
                    const pieces = [];
                    let counter = headIndex;
                    for(let j=0;j<snakeSize-1;j++){
                        pieces.push(counter+=columns);
                        const tile = $(".tile")[counter];
                        $(tile).addClass("bg-gray-500 snake-piece rounded border border-gray-50");
                    }
                }
                if(snakeDirection == "bottom"){
                    const headIndex = parseInt($(tile).data("index"));
                    const pieces = [];
                    let counter = headIndex;
                    for(let j=0;j<snakeSize-1;j++){
                        pieces.push(counter-=columns);
                        const tile = $(".tile")[counter];
                        $(tile).addClass("bg-gray-500 snake-piece rounded border border-gray-50");
                    }
                }
            }
            const createTiles = quantity => {
                Array.from(Array(quantity)).map((tile,index)=>{
                    snakeGrid.append(createTile(index));
                })
            }
            const rand = (min, max) => {
                return Math.floor(Math.random() * (max - min))
            }
            const selectRandom = size => {
                return rand(0,size-1)
            }
            const createGrid = () => {
                snakeGrid.html("");
                columns = Math.floor(snakeGrid.width()/tileWidth);
                rows = Math.floor(snakeGrid.height()/tileHeight);
                snakeStart = rows > 1 ? columns +=2 : 2;

                snakeGrid.css("--columns",columns);
                snakeGrid.css("--rows",rows);

                snakeHeadPosition = selectRandom(columns*rows);
                createTiles(columns*rows);
                createTarget(selectRandom(columns*rows));
                setSnakePosition(snakeHeadPosition);
            }
            createGrid();

            window.onresize = () => createGrid();

            $(snakeGrid).on("click",".tile",function(){
                let currentTile = parseInt($(this).data("index"));
                $(this).addClass("bg-red-400");
                let currentRow = currentTile > columns ? getCoordinates(currentTile, columns).row : 1;
                let currentColumn = currentTile > columns ? getCoordinates(currentTile, columns).col : currentTile;
                moveSnake(currentRow, currentColumn,currentTile);
            });

            function getCoordinates (currentTile, columns){
                let col = currentTile;
                let row = Math.ceil(currentTile/columns);
                for(let i=0;i<=row;i++){
                    if(col > columns){
                        col -= columns;
                    } else {
                        break;
                    }
                }
                return {row, col};
            }

            function moveSnake (clickedRow, clickedColumn,currentTile){
                let {row, col} = getCoordinates(snakeHeadPosition,columns);
                console.log("snake column:",col,snakeHeadPosition);
                console.log("clicked column:",clickedColumn,currentTile);
                let stepsX = Math.abs(col-clickedColumn);
                let stepsY = Math.abs(clickedRow - row);
                if(col > clickedColumn){
                    playerDirections.x = "left";
                    stepsX = col-clickedColumn;
                }
                if(col < clickedColumn){
                    playerDirections.x = "right";
                    stepsX = clickedColumn-col;
                }
                if(row < clickedRow){
                    playerDirections.y = "bottom";
                    stepsY = clickedRow - row;
                }
                if(row > clickedRow){
                    playerDirections.y = "top";
                    stepsY = row - clickedRow;
                }
                move(clickedRow, clickedColumn,currentTile, stepsX, stepsY);
            }

            /***
             * If the current direction for the snake is on the X axis, it changes to a direction on the Y axis to show reaction. And the vice versa. E.g If the direction is left and direction clicked is top left, it changes direction to top.
            */
            function move (clickedRow, clickedColumn,currentTile, stepsX, stepsY) {
                if(playerDirections.x == "left") {
                    if (clickedColumn == snakeColumn) {
                        moveLeft(currentTile);
                    }
                    else if(snakeDirection == "right" || snakeDirection == "left"){
                        if(playerDirections.y == "bottom"){
                            !changeDirection ? moveBottom(currentTile):moveLeft(currentTile);
                        }
                        if(playerDirections.y == "top"){
                            !changeDirection ? moveTop(currentTile):moveLeft(currentTile);
                        }
                    }
                    // moveLeft();
                } else if(playerDirections.x == "right"){
                    if (clickedColumn == snakeColumn) {
                        moveRight(currentTile);
                    }
                    else if(snakeDirection == "right" || snakeDirection == "left"){
                        if(playerDirections.y == "bottom"){
                            !changeDirection ? moveBottom(currentTile):moveRight(currentTile);
                        }
                        if(playerDirections.y == "top"){
                            !changeDirection ? moveTop(currentTile):moveRight(currentTile);
                        }
                    }
                    // moveRight();
                }
                if(playerDirections.y == "top") {
                    if (clickedRow == snakeRow) {
                        moveTop(currentTile);
                    }
                    else if(snakeDirection == "top" || snakeDirection == "bottom"){
                        if(playerDirections.x == "right"){
                            !changeDirection ? moveRight(currentTile):moveTop(currentTile);
                        }
                        if(playerDirections.x == "left"){
                            !changeDirection ? moveLeft(currentTile):moveTop(currentTile);
                        }
                    }
                    // moveTop();
                } else if(playerDirections.y == "bottom"){
                    if (clickedRow == snakeRow) {
                        moveBottom(currentTile);
                    }
                    else if(snakeDirection == "top" || snakeDirection == "bottom"){
                        if(playerDirections.x == "right"){
                            !changeDirection ? moveRight(currentTile):moveBottom(currentTile);
                        }
                        if(playerDirections.x == "left"){
                            !changeDirection ? moveLeft(currentTile):moveBottom(currentTile);
                        }
                    }
                    // moveBottom();
                }
                while (stepsX>0) {
                    stepsX--;
                    setTimeout(() => {
                        move(clickedRow, clickedColumn,currentTile, stepsX, stepsY);
                    }, 200);
                }
            }
            function moveLeft(currentTile){
                let head = $('.head');
                let body = $(".snake-piece");
                snakeHeadPosition = $(head).data('index');
                snakeDirection = "left";
                $(head).removeClass("bg-gray-600 rounded head");
                $(head).prev('.tile').addClass("bg-gray-600 rounded head");
                $(body).removeClass("bg-gray-500 snake-piece rounded border border-gray-50");
                $(body).prev(".tile").addClass("bg-gray-500 snake-piece rounded border border-gray-50"); 
                // if(snakeHeadPosition == currentTile) changeDirection = true;
            }
            function moveRight(currentTile){
                let head = $('.head');
                let body = $(".snake-piece");
                snakeHeadPosition = $(head).data('index');
                snakeDirection = "right";
                $(head).removeClass("bg-gray-600 rounded head");
                $(head).next('.tile').addClass("bg-gray-600 rounded head");
                $(body).removeClass("bg-gray-500 snake-piece rounded border border-gray-50");
                $(body).next(".tile").addClass("bg-gray-500 snake-piece rounded border border-gray-50"); 
                // if(snakeHeadPosition == currentTile) changeDirection = true;
            }
            function moveTop(currentTile){
                let head = $('.head');
                let body = $(".snake-piece");
                snakeHeadPosition = $(head).data('index');
                snakeDirection = "bottom";
                if(snakeDirection == "bottom"){
                    const pieces = [snakeHeadPosition];
                    let counter = snakeHeadPosition;
                    for(let j=0;j<snakeSize-1;j++){
                        pieces.push(counter-=columns);
                        const tile = $(".tile")[counter];
                        let newhead = $(".tile")[counter-columns];
                        $(newhead).addClass("bg-gray-600 rounded head");
                        $(head).removeClass("bg-gray-600 rounded head");
                        $(body).removeClass("bg-gray-500 snake-piece rounded border border-gray-50");
                        $(body).removeClass("bg-gray-500 snake-piece rounded border border-gray-50");
                        $(tile).addClass("bg-gray-500 snake-piece rounded border border-gray-50")
                    }
                }
                // if(snakeHeadPosition == currentTile) changeDirection = true;
            }
            function moveBottom(currentTile){
                let head = $('.head');
                let body = $(".snake-piece");
                snakeHeadPosition = $(head).data('index');
                snakeDirection = "bottom";
                if(snakeDirection == "bottom"){
                    const pieces = [snakeHeadPosition];
                    let counter = snakeHeadPosition;
                    for(let j=0;j<snakeSize-1;j++){
                        pieces.push(counter+=columns);
                        const tile = $(".tile")[counter];
                        let newhead = $(".tile")[counter+columns];
                        $(newhead).addClass("bg-gray-600 rounded head");
                        $(head).removeClass("bg-gray-600 rounded head");
                        $(body).removeClass("bg-gray-500 snake-piece rounded border border-gray-50");
                        $(body).removeClass("bg-gray-500 snake-piece rounded border border-gray-50");
                        $(tile).addClass("bg-gray-500 snake-piece rounded border border-gray-50")
                    }
                    console.log("pieces: ",pieces)
                }
                // if(snakeHeadPosition == currentTile) changeDirection = true;
            }
            // gameFrame.on("click", function(e){
            //     let domRect = e.currentTarget.getBoundingClientRect();
            //     let mouseX = e.clientX;
            //     let mouseY = e.clientY;
            //     let mx = (mouseX-domRect.x)-dot.width()/2; // height and width of the dot
            //     let my = (mouseY-domRect.y)-dot.height()/2;
            //     teleportSnake(mouseX,mouseY,mx,my);
            //     setTimeout(() => {
            //         slither(mx,my,"left")
            //     }, 500);
            // });
            // function teleportSnake (mouseX,mouseY,mx,my){
            //     let cordinates = `${mouseX},${mouseY}`;
            //     snakeGrid.addClass(`top-[${my}px] left-[${mx}px]`);
            //     dotsCount += 1;
            //     snakeGrid.append(`<div class="dot w-3 h-3 rounded bg-gray-500 border flex-shrink-0"></div>`);
            //     console.log("cordinates:",cordinates)
            //     console.log('has hit a wall:',hasHitWall(mx,my))
            // }

            // function hasHitWall (mx,my){
            //     return mx < 0 || my < 0;
            // }

            // function slither(mx,my,dir=null){
            //     if(!dir){
            //         return;
            //     }
            //     if(dir==="left"){
            //         snakeGrid.addClass(`moving-left`);
            //     }
            //     if(dir==="right"){
            //         snakeGrid.addClass(`moving-right`);
            //     }
            //     if(dir==="top"){
            //         snakeGrid.addClass(`moving-top`);
            //     }
            //     if(dir==="bottom"){
            //         snakeGrid.addClass(`moving-bottom`);
            //     }
            // }
        })
    </script>
</body>
</html>